name: Update Spotify Albums

# Allow workflow to push changes to meta.json
permissions:
  contents: write

# Triggers
on:
  workflow_dispatch:     # Manual run
  schedule:
    - cron: "0 3 * * *"   # 3 AM UTC
    - cron: "0 11 * * *"  # 11 AM UTC
    - cron: "0 19 * * *"  # 7 PM UTC

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # Checkout repository
      - uses: actions/checkout@v3
        with:
          persist-credentials: true

      # Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # NEW: Install Supabase and other dependencies from package.json
      - name: Install Dependencies
        run: npm install

      # Run update script with all 4 Secrets
      - name: Run update.js
        run: node scripts/update.js
        env:
          SPOTIFY_CLIENT_ID: ${{ secrets.SPOTIFY_CLIENT_ID }}
          SPOTIFY_CLIENT_SECRET: ${{ secrets.SPOTIFY_CLIENT_SECRET }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      # Note: We don't need the "git push" steps here anymore 
      # because your scripts/update.js file has the Git commands 
      # built-in to handle meta.json.
